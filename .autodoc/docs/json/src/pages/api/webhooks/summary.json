{
  "folderName": "webhooks",
  "folderPath": ".autodoc/docs/json/src/pages/api/webhooks",
  "url": "/.autodoc/docs/json/src/pages/api/webhooks",
  "files": [
    {
      "fileName": "stripe.ts",
      "filePath": "src/pages/api/webhooks/stripe.ts",
      "url": "/src/pages/api/webhooks/stripe.ts",
      "summary": "This code defines a webhook handler for Stripe subscriptions in the agentgpt project. The webhook handler is responsible for handling events related to customer subscriptions in Stripe. \n\nThe code imports the necessary dependencies, including `micro`, `micro-cors`, `next`, `stripe`, `env`, `prisma`, and `stripe-utils`. It then creates a new instance of the Stripe API client using the `STRIPE_SECRET_KEY` environment variable. \n\nThe `config` object is defined to disable the default body parser for the Next.js API route. The `cors` middleware is also defined to allow only `POST` and `HEAD` requests. \n\nThe `webhookHandler` function is defined to handle incoming webhook events from Stripe. It first checks if the incoming request is a `POST` request. If not, it returns a `405 Method Not Allowed` response. \n\nIf the request is a `POST` request, the function reads the raw body of the request and verifies the Stripe signature using the `stripe.webhooks.constructEvent` method. If the signature is invalid, the function returns a `400 Bad Request` response. \n\nIf the signature is valid, the function checks the type of the event. If the event is not related to customer subscriptions, the function returns a success response. If the event is related to customer subscriptions, the function retrieves the email of the customer associated with the subscription and finds the corresponding user in the database using the `prisma` ORM. \n\nThe function then updates the user's subscription status in the database based on the type of the event. If the event is `customer.subscription.deleted`, `customer.subscription.paused`, `customer.subscription.updated`, or `customer.subscription.resumed`, the function updates the user's subscription status in the database. Otherwise, the function logs an error message. \n\nFinally, the function returns a success response. \n\nThe `updateUserSubscription` function is defined to update the user's subscription status in the database. It takes the user ID and subscription object as arguments and updates the user's subscription ID in the database based on the subscription status. \n\nThe `cors` middleware is applied to the `webhookHandler` function, and the resulting function is exported as the default export of the module. \n\nThis code can be used as a webhook handler for Stripe subscriptions in the agentgpt project. It handles incoming webhook events from Stripe and updates the user's subscription status in the database accordingly.",
      "questions": "1. What is the purpose of this code?\n- This code sets up a webhook handler for Stripe subscriptions and updates the subscription status of a user in a database.\n\n2. What dependencies are being used in this code?\n- This code uses the `micro`, `micro-cors`, `next`, and `stripe` packages.\n\n3. What is the purpose of the `success` function?\n- The `success` function sends a 200 response with a JSON object indicating that the webhook was received successfully."
    }
  ],
  "folders": [],
  "summary": "The `stripe.ts` file in the `webhooks` folder is responsible for handling webhook events related to customer subscriptions in the agentgpt project. This webhook handler is crucial for keeping the user's subscription status up-to-date in the project's database, based on the events received from Stripe.\n\nThe code starts by importing necessary dependencies and creating a new instance of the Stripe API client using the `STRIPE_SECRET_KEY` environment variable. It then defines a `config` object to disable the default body parser for the Next.js API route and sets up the `cors` middleware to allow only `POST` and `HEAD` requests.\n\nThe core functionality of this file is in the `webhookHandler` function, which processes incoming webhook events from Stripe. The function first checks if the incoming request is a `POST` request and returns a `405 Method Not Allowed` response if it's not. If the request is valid, it reads the raw body of the request and verifies the Stripe signature using the `stripe.webhooks.constructEvent` method. If the signature is invalid, it returns a `400 Bad Request` response.\n\nUpon receiving a valid webhook event, the function checks the event type. If the event is not related to customer subscriptions, it returns a success response. If the event is related to customer subscriptions, it retrieves the customer's email and finds the corresponding user in the database using the `prisma` ORM. Based on the event type, the function updates the user's subscription status in the database. For example, if the event is `customer.subscription.deleted`, the user's subscription status will be updated accordingly.\n\nThe `updateUserSubscription` function is a helper function that takes the user ID and subscription object as arguments and updates the user's subscription ID in the database based on the subscription status.\n\nFinally, the `cors` middleware is applied to the `webhookHandler` function, and the resulting function is exported as the default export of the module.\n\nHere's an example of how this webhook handler might be used in the project:\n\n1. A user subscribes to a premium plan in the agentgpt project, and Stripe sends a `customer.subscription.created` webhook event.\n2. The `webhookHandler` function receives the event, verifies the signature, and checks the event type.\n3. The function retrieves the customer's email, finds the corresponding user in the database, and updates the user's subscription status to \"active\".\n4. When the user logs in to the agentgpt project, their subscription status is now \"active\", granting them access to premium features.\n\nIn summary, the `stripe.ts` webhook handler plays a crucial role in managing user subscriptions in the agentgpt project by processing webhook events from Stripe and updating the user's subscription status in the database accordingly.",
  "questions": ""
}